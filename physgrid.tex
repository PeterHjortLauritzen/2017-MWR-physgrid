%% Version 4.3.2, 25 August 2014
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Template.tex --  LaTeX-based template for submissions to the 
% American Meteorological Society
%
% Template developed by Amy Hendrickson, 2013, TeXnology Inc., 
% amyh@texnology.com, http://www.texnology.com
% following earlier work by Brian Papa, American Meteorological Society
%
% Email questions to latex@ametsoc.org.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PREAMBLE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Start with one of the following:
% DOUBLE-SPACED VERSION FOR SUBMISSION TO THE AMS
%\documentclass{ametsoc}

% TWO-COLUMN JOURNAL PAGE LAYOUT---FOR AUTHOR USE ONLY
 \documentclass[twocol]{ametsoc}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% To be entered only if twocol option is used

\journal{mwr}

%  Please choose a journal abbreviation to use above from the following list:
% 
%   jamc     (Journal of Applied Meteorology and Climatology)
%   jtech     (Journal of Atmospheric and Oceanic Technology)
%   jhm      (Journal of Hydrometeorology)
%   jpo     (Journal of Physical Oceanography)
%   jas      (Journal of Atmospheric Sciences)	
%   jcli      (Journal of Climate)
%   mwr      (Monthly Weather Review)
%   wcas      (Weather, Climate, and Society)
%   waf       (Weather and Forecasting)
%   bams (Bulletin of the American Meteorological Society)
%   ei    (Earth Interactions)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Citations should be of the form ``author year''  not ``author, year''
\bibpunct{(}{)}{;}{a}{}{,}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%% To be entered by author:

%% May use \\ to break lines in title:

\title{Physics-dynamics coupling with element-based high-order Galerkin methods: quasi equal-area physics grid}

%%% Enter authors' names, as you see in this example:
%%% Use \correspondingauthor{} and \thanks{Current Affiliation:...}
%%% immediately following the appropriate author.
%%%
%%% Note that the \correspondingauthor{} command is NECESSARY.
%%% The \thanks{} commands are OPTIONAL.

    %\authors{Author One\correspondingauthor{Author One, 
    % American Meteorological Society, 
    % 45 Beacon St., Boston, MA 02108.}
% and Author Two\thanks{Current affiliation: American Meteorological Society, 
    % 45 Beacon St., Boston, MA 02108.}}

\authors{Adam R. Herrington\correspondingauthor{Adam R. Herrington, School of Marine and Atmospheric Sciences, Stony Brook University, Stony Brook, New York, USA.}}

%% Follow this form:
    % \affiliation{American Meteorological Society, 
    % Boston, Massachusetts.}

\affiliation{School of Marine and Atmospheric Sciences, Stony Brook University, Stony Brook, New York, USA.}

%% Follow this form:
    %\email{latex@ametsoc.org}

\email{adam.herrington@stonybrook.edu}

%% If appropriate, add additional authors, different affiliations:
\extraauthor{Peter H. Lauritzen}
\extraaffil{Climate and Global Dynamics, National Center for Atmospheric Research, 1850 Table Mesa Drive, Boulder, Colorado, USA.}
\extraauthor{Mark A. Taylor}
\extraaffil{Sandia National Laboratories, Albuquerque, New Mexico, USA.}
\extraauthor{Steve Goldhaber and Brian E. Eaton}
\extraaffil{Climate and Global Dynamics, National Center for Atmospheric Research, 1850 Table Mesa Drive, Boulder, Colorado, USA.}
\extraauthor{Kevin A. Reed}
\extraaffil{School of Marine and Atmospheric Sciences, Stony Brook University, State University of New York, Stony Brook, New York.}
\extraauthor{Paul A. Ullrich}
\extraaffil{Department of Land, Air and Water Resources, University of California, Davis, California, USA.}

%% May repeat for a additional authors/affiliations:

%\extraauthor{}
%\extraaffil{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% ABSTRACT
%
% Enter your abstract here
% Abstracts should not exceed 250 words in length!
%
% For BAMS authors only: If your article requires a Capsule Summary, please place the capsule text at the end of your abstract
% and identify it as the capsule. Example: This is the end of the abstract. (Capsule Summary) This is the capsule summary. 

\abstract{Atmospheric modeling with element-based high-order Galerkin methods presents a unique challenge to the conventional physics-dynamics coupling paradigm, due to the highly irregular distribution of nodes within an element and the distinct numerical characteristics of the Galerkin method. The conventional coupling procedure is to evaluate the physical parameterizations ({\em{physics}}) on the dynamical core grid. Evaluating the physics at the nodal points exacerbates numerical noise from the Galerkin method, enabling and amplifying local extrema at element boundaries. Grid imprinting may be substantially reduced through the introduction of an entirely separate, approximately isotropic finite-volume grid for evaluating the physics forcing. Integration of the spectral basis over the control-volumes provides an area average state to the physics, which is more representative of the state in the vicinity of the nodal points rather than the nodal point itself, and is more consistent with the notion of a `large-scale state' required by conventional physics packages. This study documents the implementation of a quasi-equal area physics grid into NCAR's Community Atmosphere Model with Spectral Elements, and is shown to be effective at mitigating grid imprinting in the solution. The physics grid is also appropriate for coupling to other components within the Community Earth System Model, since the coupler requires component fluxes to be defined on a finite-volume grid, and one can be certain that the fluxes on the physics grid are indeed, volume-averaged.}

\begin{document}

%% Necessary!
\maketitle


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% MAIN BODY OF PAPER
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%

%% In all cases, if there is only one entry of this type within
%% the higher level heading, use the star form: 
%%
\section{Introduction}
An increasing number of numerical methods publications in the atmospheric science literature concern transport, shallow-water, and three-dimensional models employing element-based high-order Galerkin discretizations such as finite-element and discontinuous Galerkin methods \citep[for an introduction to these methods see, e.g., ][]{Durran,NLL2011LNCSE,U2014GMD}. Some global models based on Galerkin methods have reached a level of maturity for which they are being considered for next generation climate and weather models due to their inherent conservation properties, high-order accuracy (for smooth problems), high parallel efficiency, high processor efficiency, and geometric flexibility facilitating mesh-refinement applications. NCAR's Community Atmosphere Model \citep[CAM; ][]{CAM5} offers a dynamical core based on continuous Galerkin finite elements \citep{TF2010JCP}, referred to as CAM-SE \citep[CAM Spectral Elements; ][]{DetAl2012IJHPCA,TES2008JPCS,LetAl2018JAMES}. CAM-SE is, in particular, being used for high resolution climate modeling \citep[e.g., ][]{JAME:JAME20125,RetAl2015GRL,BETAL2018CC} and static mesh-refinement applications \citep[e.g., ][]{FT2004MWR,ZetAl2014JC,ZetAl2014JCb,GetAl2014GMD,RHUZ2016JAMC}. Other examples of models based on high-order Galerkin methods that are being considered for `operational' weather-climate applications are \citet{Giraldo20083849}, \citet{NCT2009CF} and \citet{BSBDK2013TCFD}.

\begin{figure}[t]
\noindent\includegraphics[width=19pc,angle=0]{figs/quadrature-fig/gll.pdf}\\
\caption{Example of CAM-SE GLL quadrature grids, marked with red filled circles, (a \& c) on the cubed-sphere and (b \& d) in an element. (a)-(b) and (c)-(d) use $4\times 4$ ($np=4$) and $8\times 8$ ($np=8$) GLL quadrature points in each element, respectively. (a) and (c) have the same average grid-spacing at the Equator (7.5$^\circ$) which is obtained by using (a) $4\times 4$ ($ne=4$) and (b) $2\times 2$ ($ne=2$) elements on each cubed-sphere face/panel, respectively. The element boundaries are marked with thick light blue lines. The grid configurations shown on (a) and (c) are referred to as $ne4np4$ and $ne2np8$, respectively.}
\label{fig:gll-grids}
\end{figure}

Assumptions inherent to the physical parameterizations (also referred to as {\em{physics}}) require the state passed by the dynamical core represent a `large-scale state', for example, in quasi-equilibrium-type convection schemes \citep{AS1974JAS,PC2008JAS}. In finite-volume methods, one may think of the dynamical core state as the average state of the atmosphere over a control volume, and for resolutions typical of climate simulations is entirely consistent with the notion of a `large-scale state'. For finite-difference methods the point value is thought of as representative for the atmospheric state in the vicinity of the point value and one can usually associate a volume with the grid-point. Hence the physics grid (the grid on which the state of the atmosphere is evaluated and passed to physics) and the dynamics grid (the grid the dynamical core uses) coincide. Having the physics and dynamics grids coincide is obviously convenient since no interpolation is needed (which could disrupt conservation properties) and the number of degrees of freedom on both grids is exactly the same. 

For the regular latitude-longitude, cubed-sphere and icosahedral grids the distance between the grid-points is gradually varying for finite-volume/finite-difference discretizations. For high-order element-based Galerkin methods, the dynamical core grid is defined by the quadrature points. In CAM-SE, these are the Gauss-Lobatto-Legendre (GLL) quadrature nodes. A unique aspect of the high-order quadrature rules is that the nodes within an element are located at the roots of the basis set, which may be irregularly spaced. For example, Figure \ref{fig:gll-grids} shows GLL points on an individual element of a cubed-sphere grid for degree 3 ($np=4$ quadrature points) and degree 7 ($np=8$ quadrature points) Lagrange polynomial basis used in CAM-SE. Both grids have the same average resolution on the sphere (due to different number of elements), however, the higher the order of the quadrature rule the less equi-distant are the quadrature points. GLL quadrature points cluster near the edges and, in particular, the corners of the elements.

The resolved scales of motion are not determined by the distance between quadrature nodes, but rather the degree of the polynomial basis in each element. The nodes may be viewed as irregularly spaced samples of an underlying spectrally truncated state. From this perspective, one might expect the nodal solutions to be independent of location within an element. While the interior quadrature nodes are $C^{\infty}$ in CAM-SE (i.e. the basis representation is infinitely smooth and all derivatives are continuous), the smoothness of boundary nodes are constrained by the need to patch neighboring solutions together to form the global basis set, an operation known as the direct stiffness summation \citep[DSS; ][]{MadayPatera87,canuto2007}. The DSS operation is attractive because it allows for high-order accuracy with minimal communication between elements, but degrades the solution to $C^0$ at element boundaries (i.e., all derivatives are discontinuous). The DSS operation is thoroughly explained in the schematic in Figure~\ref{fig:se-schematic} and these details are not repeated here. Through evaluating the physics at the nodal points, strong grid-scale forcing or oscillatory behavior near an element boundary may exacerbate the discontinuity, and our initial expectation, that the nodal solutions are independent of within-element location, is unlikely for non-smooth problems, e.g., the presence of rough topography or moist physics grid-scale forcing (see Figure~\ref{fig:se-schematic}). 

To test the degree to which nodal solutions depend on within-element position, an aqua-planet simulation \citep{NH2000ASL,MWO2016JAMES} is carried out using CAM-SE. The probability density distribution of the upward vertical pressure velocity ($\omega$), conditionally sampled based on three categories - `interior', `edge' and `corner' nodes - is provided in Figure~\ref{fig:omega-se-volumes}. There is an apparent dependence on nodal location, with interior nodes being characteristically sluggish, and corner and edge nodes having systematically larger magnitude vertical motion. This behavior is consistent with the smoothness properties of the different nodal locations. The pressure gradient at the element boundaries is discontinuous and systematically tighter (Figure~\ref{fig:se-schematic}), resulting in greater vertical motion at `edge' and `corner' nodes (Figure~\ref{fig:omega-se-volumes}). The main division of solutions shown in Figure~\ref{fig:omega-se-volumes} is primarily between whether a node is, or is not situated on an element boundary, and is a nuanced signature of high-order element-based Galerkin methods for non-smooth problems.

\begin{figure}[t]
\noindent\includegraphics[width=19pc,angle=0]{figs/temp_pdf_omg_np4_v_pg3_CROP.pdf}\\
\caption{Probability density distribution of instantaneous upward $\omega$ in a pair of aqua-planet simulations using CAM4 physics. Figure is constructed from one year of six hourly data, at all vertical levels. (Left) $ne30np4$ configuration conditionally sampled for interior, edge and corner node control volumes, and (Right) $ne30pg3$ configuration, but sampled by within-element physics grid-cell location. Note the consistently larger magnitude $\omega$ for boundary nodes compared with interior nodes, and that the bias is eliminated through mapping to a quasi-equal area physics grid.}\label{fig:omega-se-volumes}
\end{figure}

If the conventional physics-dynamics coupling paradigm is applied to CAM-SE, then the physics are to be evaluated at the GLL nodes, and a volume associated with the quadrature point should be defined. An example of that is shown on Figure \ref{fig:cv-grids} where control volumes have been defined around the quadrature points so that the spherical area of the control volumes exactly match the Gaussian weight multiplied by the metric term (these weights are used for integrating the basis functions over the elements and can therefore, in this context, be interpreted as areas). This grid is used in the NCAR CESM (Community Earth System Model) coupler for passing states between ocean, atmosphere and land components since the current remapping method is finite-volume based and therefore requires control volumes (it is noted that methods exist that do not require control volumes for conservative interpolation, e.g., \cite{UT2015MWR}). Hence the components `see' an irregular atmospheric grid. Similarly, the parameterizations in the atmosphere `see' a state that is anisotropically sampled in space \citep[see Figure 1 and 5 in ][]{KetAl2008JGR}.

\begin{figure}[t]
\noindent\includegraphics[width=19pc,angle=0]{figs/se_gll_cv_grid.eps}\\
\caption{An example of control volumes constructed around GLL quadrature points ($ne4np4$) so that the spherical area of the control volumes exactly match the quadrature weight multiplied by the metric factor.}
\label{fig:cv-grids}
\end{figure}


The quadrature grid in element-based Galerkin methods is defined to perform mathematical operations on the basis functions, e.g., computing gradients and integrals, rather than evaluating the state variables for physics-dynamics coupling. One may argue that it would be more consistent to integrate the basis functions over quasi-equal area control volumes within each element and pass those control volume average values to physics rather than irregularly spaced quadrature point values. In this case when integrating basis functions over control volumes a grid-cell average value is more representative of the values near the extrema at the element boundary than the quadrature point value. The relationship between the nodal values, the basis functions and the proposed control volumes is illustrated schematically in one-dimension in parts (f) and (i) in Figure~\ref{fig:se-schematic}. 

\begin{figure*}[t]
\noindent\includegraphics[width=38pc,angle=0]{figs/se-schematic-arh-CROP.pdf}\\
\caption{A one-dimensional schematic illustration on how CAM-SE advances the solution to the equations of motion in time. Consider a transect across three elements. The filled circles are the GLL quadrature points in each element ($np=4$). Note that the quadrature points on the boundary are shared between elements. (a) Smooth initial condition with quadrature points in red. (b) The solution to the equations of motion are advanced in time (one Runge-Kutta step) independently in each element leading to the quadrature values marked with filled blue circles. The Lagrange basis is shown as curves connecting the blue circles. There are now two solutions, one from left and one from right, for the quadrature points at the element boundaries. In CAM-SE a numerical flux is applied to the element boundary that results in a simple average of the two nodal values, but degrades the boundary nodes to $C^0$. Note that the averaging changes the Lagrange polynomials throughout except at the internal quadrature points. (c) shows the solution after applying the boundary flux. (d) Assume there is a grid-scale physics forcing that increases the quadrature value at the location of the arrow. (e) The solution is now clearly $C^0$ at the element boundary. (f) Vertical bars indicate the average values resulting from integrating the basis functions over the control volumes of the quasi-equal area physics grid. (g)-(i), repeats the scenario of (d)-(f), but instead with a forcing applied to an interior node (arrow in (g)), illustrating the $C^{\infty}$ smoothness of interior nodes.}
\label{fig:se-schematic}
\end{figure*}

It is the purpose of this paper to document the implementation of a quasi-equal area physics grid into CAM-SE, in which the physics and dynamics grids are entirely separated as illustrated in one dimension in parts (f) and (i) of Figure~\ref{fig:se-schematic}, and the impact on model solution. The implementation of the physics grid configuration into CAM-SE is presented in Section 2. Idealized model configurations with and without topography are presented in Section 3, illustrating the physics grid is effective at mitigating undesirable grid imprinting in the solution. Section 4 contains a discussion of results and concluding remarks. 

\section{Methods}\label{sec:methods}
Here we focus on CAM-SE, however, in principle the methods apply to any element-based high-order Galerkin model. The physics grid in CAM-SE is defined by sub-dividing each element using equi-angular gnomonic coordinate lines to define the sides of the physics grid control volumes (see the Appendix for details). Note that the element boundaries are defined by equi-angular gnomonic grid lines. The notation $pg=3$ refers to the configuration where the elements are divided into $pg\times pg=3\times 3$ quasi equal-area physics grid cells (see Figure \ref{fig:np4_pg3}). Defining the physics grid by sub-dividing elements makes it possible to use the same element infrastructure as already used in CAM-SE, thereby facilitating its implementation. Here we make use of the $ne30np4$ and $ne30pg3$ grids that use GLL quadrature point physics grid (physics and dynamics grid coincide), and the same ($pg=3$) resolution quasi equal-area physics grids, respectively. In all configurations we use degree three Lagrange basis ($np=4$) and $ne\times ne=30\times 30$ elements on each cubed-sphere panel resulting in an average GLL quadrature point spacing at the Equator of $1^\circ$, a common resolution used for global modeling. %Vertical grid spacing is the standard CAM5 configuration ($nlev=30$)

\begin{figure}[t]
\noindent\includegraphics[width=19pc,angle=0]{figs/np4_pg3.pdf}\\
\caption{A schematic illustration of an element, indicating the relationship between (left) the dynamical core grid, and (right) the proposed quasi-equal area physics grid. The physics grid contains $pg\times pg=3\times 3$ grid cells in each element.}
\label{fig:np4_pg3}
\end{figure}

A consequence of separating physics and dynamics grids is that the atmospheric state must be mapped to the physics grid and the physics tendencies must be mapped back to the dynamics grid. This is discussed in separate sections below. When separating physics and dynamics grids it is advantageous to use a vertical coordinate that is static during physics-dynamics coupling. This was one motivation to switch to a dry-mass vertical coordinate in CAM-SE \citep{LetAl2018JAMES}; since dry mass remains constant throughout physics the dry-mass vertical coordinate remains fixed during physics-dynamics coupling. We will be using this version of CAM-SE in this paper.
\subsection{Mapping state from dynamics grid (GLL) to physics grid (pg)}
The dynamics state is defined on the GLL grid in terms of temperature $T^{(gll)}$, zonal wind component $u^{(gll)}$, meridional wind component $v^{(gll)}$, and dry pressure level thickness $\Delta p^{(gll)}$. In the mapping of the atmospheric state to the physics grid it is important that the following properties are met:
\begin{enumerate}
\item conservation of scalar quantities such as mass and dry thermal energy,\label{prop1}
\item for tracers; shape-preservation (monotonicity), i.e. the mapping method must not introduce new extrema in the interpolated field, in particular, negatives,\label{prop2}
\item consistency, i.e. the mapping preserves a constant,\label{prop3}
\item linear correlation preservation.
\end{enumerate}
Other properties that may be important, but not pursued here, includes total energy conservation and axial angular momentum conservation. We argue that the most consistent method for mapping scalar state variables from the GLL grid to the physics grid is to integrate the Lagrange basis function representation (used by the SE dynamical core) over the physics grid control volumes, i.e. integrate the basis function representation of $\Delta p^{(gll)}\times T^{(gll)}$ and $\Delta p^{(gll)}$ over the physics grid control volume \citep[see, e.g., ][]{LTOUNGK2017MWR,UT2015MWR}
\begin{eqnarray}
\Delta p^{(pg)}&=&\frac{1}{A^{(pg)}}\int_{A^{(pg)}}\Delta p^{(gll)}\, dA,\\
T^{(pg)}&=&\frac{}{A^{(pg)}\Delta p^{(pg)}}\int_{A^{(pg)}}T^{(gll)}\Delta p^{(gll)}\, dA,
\end{eqnarray}
where $A^{(pg)}$ is the physics grid area. The integrals are numerically computed using the GLL quadrature rule. Thermal energy and dry air mass is conserved and the mapping is consistent. For the wind, which is a vector, the zonal and meridional wind components are mapped by transforming to contra-variant wind components, evaluating the basis function representation thereof at the equi-angular center of the physics grid control volumes and then transform back to latitude-longitude coordinate system winds. All of the operations are local to the element and do not require communication between elements.

The mapping of tracers is more problematic since the SE basis function representation is oscillatory although the shape-preserving filter guarantees shape-preservation at the GLL nodes \citep{GTS2014JCP}. To avoid this issue we use the CAM-SE-CSLAM version of CAM-SE \citep[Conservative Semi-Lagrangian Multi-tracer transport scheme][]{LTOUNGK2017MWR}, where tracers are advected on the $pg=3$ physics grid. Note that in CAM-SE-CSLAM the dry mass internally predicted by CSLAM, $\Delta p^{(cslam)}$, is, by design, equal to $\Delta p^{(gll)}$ integrated over the CSLAM/physics grid control volume \citep{LTOUNGK2017MWR}. Since the tracer grid and physics grids are co-located and $\Delta p^{(pg)}=\Delta p^{(cslam)}$ then the  mass conservation, correlation preservation, consistency and shape-preservation constraints are inherently fulfilled.
%
\subsection{Mapping tendencies from physics grid (pg) to dynamics grid (GLL)}
The physics tendencies are computed on the finite-volume physics grid and are denoted $f_T^{(pg)}$,$f_u^{(pg)}$,$f_v^{(pg)}$, and $f_m^{(pg)}$. Note that dry air mass is not modified by physics and hence there is no tendency for dry mass,  $f_{\Delta p}\equiv 0$. Also, it is important to map tendencies and not state from the physics grid to GLL grid otherwise one will get spurious tendencies from mapping errors when the actual physics tendency is zero (unless a reversible map is used).

It is important that this process:
\begin{enumerate}
\item for tracers; mass tendency is conserved,
\item for tracers; in each tracer grid cell the mass tendency from physics must not exceed tracer mass available in tracer grid cell (it is assumed that the physics tendency will not drive tracer mixing ratio negative on the physics grid),\label{item:phys2fvm_consistency}
\item linear correlation preservation,
\item consistency, i.e. the mapping preserves a constant tendency.
\end{enumerate}
Other properties that may be important, but not pursued here, includes total energy conservation (incl. components of total energy) and axial angular momentum conservation. Scalar variables are mapped from physics grid to GLL grid using a tensor-product Lagrange interpolation. The local coordinates on a cubed-sphere are discontinuous at the element edges so the interpolation requires special attention at the cube corners and edges. The details are provided in the Appendix. Lagrange interpolation preserves a constant (including zero) and linear correlations. Tracer and physics grids are co-located so tracer mass, tracer shape, and tracer correlations are trivially preserved on the tracer grid; and the inconsistency in point \ref{item:phys2fvm_consistency} above will not appear. 

We do, however, need to map water tracers (such as water vapor, cloud liquid and cloud ice) to the GLL grid to account for moist effects in the equations of motion solved on the GLL grid. The CSLAM water tracer mixing ratios updated by physics tendencies are mapped to the GLL grid using the same tensor cubic interpolation as is used for temperature and velocity components. In between the calls to physics (i.e. in the dynamical core sub-stepping) the water tracers are advected on the GLL grid with the SE method \citep[see section 3.5 in ][]{LetAl2018JAMES}. Water tracer mass is not conserved in the mapping from tracer/physics grid to GLL grid. This procedure makes sure that the water tracers on the GLL grid are 'nudged' to the CSLAM solution for water tracers and the mass budget is closed on the tracer/physics grid.

In the mapping algorithm from physics to dynamics it was found (a) important to use an algorithm that is smooth across element boundaries and (b) that obtaining mass-conservation without excessive grid imprinting at element edges is difficult. In regard to (a), using an algorithm that only uses information from an element of control volumes will (at best) be $C^0$ at the element boundaries where most of the GLL points are located. A stencil that extends beyond one element is necessary. Mass-conservation requires a control volume to be defined around the GLL points \cite[see, .e.g., Figure \ref{fig:cv-grids} in this paper or Figure 8b in ][]{UDJ2016MWR}. These volumes are artificial and not consistent with the SE method. Integrating the CSLAM reconstruction of water tracers of such artificial control volumes led to GLL node grid imprinting in the mapping and will not preserve a constant mixing ratio since the mapping of $\Delta p^{(pg)}$ to GLL will not yield the GLL node value for dry pressure-level thickness (i.e. the maps are not reversible). Hence, after much experimentation, the best results in terms of grid-imprinting were obtained with tensor-cubic interpolation and by using the CAM-SE-CSLAM configuration.


\section{Results}

The CAM aqua-planet reference configuration \citep{NH2000ASL,MWO2016JAMES} consists of an ocean covered planet in a perpetual equinox, with fixed, zonally symmetric sea surface temperatures idealized after the present day climatology. Two year long aqua-planet simulations are performed using CAM-SE in the $ne30np4$ configuration, and CAM-SE-CSLAM in a $ne30pg3$ configuration (CAM-trunk revision $88685$). A plot similar to Figure \ref{fig:omega-se-volumes} is constructed for the $ne30pg3$ simulation, in which a probability density distribution of upward $\omega$ is conditionally sampled based on location within the element. In the $ne30pg3$ configuration, the sampling is based on a grid cell index 1-9, corresponding to the control volume location within the element. Through the use of the physics grid, the dynamical core state appears independent of location within the element, a marked improvement over the $ne30np4$ configuration (Figure \ref{fig:omega-se-volumes}). Since the state is independent of in-element location, it follows that the physics forcing, which is evaluated from the state, should also be independent of in-element location. 

The low-level, mean and variance of the physics tendencies in the two aqua-planet simulations are shown in Figure \ref{fig:tendency_imprint}. The mean states in $ne30np4$ and $ne30pg3$ resemble one another, consistent with the similar climatological zonal mean precipitation rate in the simulations (not shown). The mean physics tendencies contains modest grid imprinting in the $ne30np4$ configuration (one must look closely near the storm-track regions), while in the variance field, grid imprinting is both ubiquitous and unmistakable. The variance is larger on boundary nodes, manifesting as a `stitching' pattern resembling the cube-sphere grid. In $ne30pg3$, the grid imprinting is all but eliminated based on the mean and variance of the physics tendencies (Figure~\ref{fig:tendency_imprint}), consistent with our expectation.

As stated in Section \ref{sec:methods}, the mapping of the state to the physics grid and the reverse interpolation of physics tendencies to the GLL grid is not total energy conserving. CAM has a global energy fixer \citep{WOHTTV2015JAMES} which can be used to estimate the errors associated with the mapping algorithms. To do so, it is presumed that there are no compensating mapping errors in going to and from the physics and dynamics grids, and that CAM-SE-CSLAM and CAM-SE have the same energy dissipation rates. Under these assumptions the spurious globally integrated total energy errors due to the mapping algorithm is estimated to be approximately 0.0025 $W/m^2$ in the aqua-planet simulations. In comparison, the dynamical core total energy dissipation is on the order of 0.1 $W/m^2$ \citep{LetAl2018JAMES}. 

\begin{figure*}[t]
\noindent\includegraphics[width=37pc,angle=0]{figs/QPC4_bar_skk.pdf}\\
\caption{Mean (left) and variance (right) of the low level temperature tendencies from the physical parameterizations on the GLL grid, with the $ne30np4$ configuration, (top row) and $ne30pg3$ configuration (bottom row), in a pair of year-long aqua-planet simulations after \cite{MWO2016JAMES}. Grid imprinting is observed along the element boundaries in $ne30np4$, but is absent from the $ne30pg3$ simulation.}
\label{fig:tendency_imprint}
\end{figure*}

Grid imprinting associated with the flow around obstacles is more problematic than that encountered on the aqua-planets. In order to diagnose grid imprinting due to topographic flow, an idealized held-suarez configuration \citep{HS1994} is outfitted with real world topography after \cite{FRETAL2000WMR,BETAL2006MWR}, and run for 1200 days in the $ne30np4$ and $ne30pg3$ configurations. Figure~\ref{fig:FHS-contours} shows the mean $\omega$ at two different vertical levels in the middle troposphere. The data are plotted on the control volume grid (e.g., Figure~\ref{fig:cv-grids}), in order to delineate whether a particular value is associated with an interior, edge or element boundary node. 

At higher latitudes (e.g., the southern Andes), the flow is smooth, conforming reasonably to the underlying topography. At lower latitudes (within 20 to 30 degrees from the equator), over the Andes or the Himalayas, their is a clear preference for extrema to occur at the element boundaries (Figure~\ref{fig:FHS-contours}). The vertical structure of $\omega$ in regions of strong grid-imprinting indicates full-troposphere upward/downward motion (not shown). Grid imprinting is therefore more common in regions of weak stratification, such as occurs in the deep tropics, with forced up-slope flow facilitating the release of gravitational instability. Resolved updrafts/downdrafts often align with the element boundaries due to its systematically tighter pressure gradients, as explained in Figure~\ref{fig:se-schematic}. This type of grid imprinting has been previously indentified in CAM-SE in an AMIP configuration (Figure $7$ in \cite{gmdd-8-4623-2015}), manifesting as a band of precipitation at the foot of Himalayas.   

\begin{figure*}[t]
\noindent\includegraphics[width=37pc,angle=0]{figs/FHS-contours-CROP.pdf}\\
\caption{Mean $\omega$ at two model levels in the middle troposphere, in a Held-Suarez configuration outfitted with real world topography. (Left) CAM-SE state on the GLL grid, $ne30np4$, (Middle) CAM-SE-CSLAM state on the GLL grid, $ne30np4$ and (Right) CAM-SE-CSLAM state on the physics grid, $ne30pg3$. The $\omega$ fields are computed from a 1200 day Held-Suarez simulation. The data are contoured according to a `cell fill' approach, in which the coupler grids (e.g, Figure~\ref{fig:cv-grids}) are used to delineate the vertices of the control volumes.} 
\label{fig:FHS-contours}
\end{figure*}

Through the use of the quasi-equal area physics grid, grid imprinting due to topographic flow is reduced (Figures~\ref{fig:FHS-contours}). Figure~\ref{fig:FHS-contours} also shows the state in CAM-SE-CSLAM, but on the dynamical core grid. Arguably, grid imprinting due to topography in CAM-SE-CSLAM is not much of an improvement over CAM-SE, from the perspective of the dynamical core grid. Some regions (e.g., the Andes) appear to have a larger grid imprinting signal, relative to CAM-SE, while other regions (e.g., Himalayas) indicate an improvement. The native topography lives on the physics grid, and the topography is mapped to the nodal points at run-time in CAM-SE-CSLAM. Mapping topography to the quadrature nodes ensures that no new extrema will be introduced to the boundary nodes, where the solution is least smooth. This effect can not be very large, apparent from the conflicting effect of the $ne30pg3$ configuration on grid imprinting on the dynamical core grid. From the perspective of the physics grid, the CAM-SE-CSLAM solution clearly mitigates the influence of grid-induced extrema on the state (Figure~\ref{fig:FHS-contours}). The reduction in grid imprinting in CAM-SE-CSLAM is therefore almost entirely a result of the smoothing effect of integrating the basis functions over the control volumes of the physics grid.

% \subsection{First secondary heading}

% \subsubsection{First tertiary heading}

% \paragraph{First quaternary heading}


\section{Conclusions}

Element-based high-order Galerkin Methods possess many of the attractive qualities recommended for next generation global atmospheric models. Among these, high-order accuracy is achieved with minimal communication between elements, allowing for near perfect scaling on massively parallel systems. Element communication amounts to a numerical flux applied to the element boundaries, reconciling overlapping solutions of adjacent elements but degrading the smoothness of the boundary nodes in the process (to $C^0$). For non-smooth problems, gradients are systematically tighter at the element boundaries, and local extrema often characterize the boundary nodes. This behavior is illustrated using NCAR's Community Atmosphere Model with Spectral Elements dynamics (CAM-SE) in an aqua-planet configuration, and in a Held-Suarez configuration with real-world topography. 

The authors argue that the conventional physics-dynamics coupling paradigm, in which the physical parameterizations are evaluated on the dynamical core grid, exacerbates grid imprinting. A separate physics grid is proposed and implemented in CAM-SE, and referred to as CAM-SE-CSLAM, through dividing the elements into quasi-equal areas with equivalent degrees of freedom. The state is mapped to the physics grid with high-order accuracy through integrating CAM-SE's Lagrange basis functions over the control volumes. Control volumes near element boundaries now represent a state in the vicinity of the extrema produced through the boundary exchange, as opposed to the the nodal value itself. These control volumes are also compatible with a `large-scale state' as required by the physical parameterizations. The physical parameterizations are evaluated on the finite volume grid, and the forcing terms are mapped back to the dynamical core grid using a cubic tensor-product Lagrange interpolation. In aqua-planet simulations, evaluating the parameterizations on the physics grid removes any obvious dependence of proximity to the element boundary, resulting in a more realistic state with negligible grid imprinting. The mapping algorithm does not conserve total energy, but it is estimated that these errors are one to two orders of magnitude less than the total energy dissipation from the dynamical core.

In CAM-SE-CSLAM, the physics grid replaces the default CAM-SE quadrature point-based coupler grid (Figure~\ref{fig:cv-grids}) to compute fluxes between model components in the Community Earth System Model (CESM). The appeal here is two-fold. Through integrating the Lagrange basis functions over control volumes, one can be certain that the fluxes computed from this grid are a volume averaged flux. The same can not be said for CAM-SE, where the nodal values are effectively assigned to each control volume. The second advantage of the new coupler grid is that extrema occurring on boundary nodes may no longer influence other model components, in simulations without rough topography. While grid imprinting is reduced almost entirely in the aqua-planets, experiments with real-world topography reduces, but does not eliminate imprinting from the mean state. The quasi-equal area physics grid is nonetheless effective at mitigating numerical nuances associated with high-order element-based Galerkin methods, for non-smooth problems.  

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% ACKNOWLEDGMENTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
\acknowledgments
NCAR is sponsored by the National Science Foundation (NSF). Herrington thanks NCAR's Computational and Information Systems Laboratory (CISL) and NCAR's Climate and Global Dynamics division (CGD) for computational resources and technical support. Herrington, Reed, and Lauritzen are grateful to the NCAR Advanced Study Program graduate visitor program for funding Herrington's 12-month visit. Goldhaber was partially supported by the Accelerated Climate Modeling for Energy (ACME) project, and work package $12-015334$ ``Multiscale Methods for Accurate, Efficient, and the Acelerated Scale-Aware Models, both funded through the U.S. Department of Energy Office of Biological and Environmental Resarch. Goldhaber is also partially supported through NSF award AGS-$1500187$ ``Development and Testing of a Global Quasi 3-D multi Modeling Framework." Model source code from this study is available from the CESM repository http://svn-ccsm-models.cgd.ucar.edu/cam1/trunk.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% APPENDIXES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Use \appendix if there is only one appendix.
\appendix
The mapping of the physics tendencies from the physics grid to the GLL grid is done with tensor-cubic Lagrange interpolation. The elements of the cubed-sphere in SE are created from an equi-angular gnomonic projection. Consider one element $(\alpha,\beta) \in \left[ \alpha^{(elem)}_1,\alpha^{(elem)}_2 \right]\times \left[ \beta^{(elem)}_1,\beta^{(elem)}_2\right]$, where $(\alpha,\beta)$ are central angle coordinates and $\alpha^{(elem)}_1$ and $\alpha^{(elem)}_2$ are the minimum and maximum central angles in the $\alpha$-coordinate direction, respectively, and similarly for $\beta$. Let $\Delta \alpha^{(elem)}=\alpha^{(elem)}_2-\alpha^{(elem)}_1$ and $\Delta \beta^{(elem)}=\beta^{(elem)}_2-\beta^{(elem)}_1$. The physics grid cell central angle centers are located at
\begin{multline}
(\alpha^{(pg)}_i,\beta^{(pg)}_j)= \Big[ \alpha^{(elem)}_1+\left(i-\tfrac{1}{2}\right) \Delta \alpha^{(pg)},\\
                                      \beta^{(elem)}_1+\left(j-\tfrac{1}{2}\right) \Delta \beta^{(pg)}\Big],
\end{multline}
where $\Delta \alpha^{(pg)}=\Delta \beta^{(pg)}=\frac{\Delta \alpha^{(elem)}}{pg}=\frac{\Delta \beta^{(elem)}}{pg}$. The interpolation is performed in central-angle coordinates using tensor product cubic interpolation. For elements located on a cubed-sphere edge or corner the coordinate system for neighboring elements may be on a different panel. To take into account this coordinate change the central angle locations of physics grid cell centers located on other panels are transformed to the coordinate system of the panel the element in question is located on \cite[the transformations are given in, e.g.,  ][]{NTL2005MWRb}. An illustration is given in Figure \ref{fig:mapping} for an element located in the lower left corner of a panel. The element in question is $(\xi,\chi)\in (-1,1)^2$ where, for simplicity, we have transformed the element coordinates into normalized coordinates $(\xi,\chi) = \left( \frac{ 2\left(\alpha^{(pg)}-\alpha^{(elem)}_1\right)}{\Delta \alpha^{(elem)}}-1,\frac{2\left( \beta^{(pg)}-\beta^{(elem)}_1\right)}{\Delta \beta^{(elem)}}-1\right)$; also used internally in the SE dynamical core \citep[see, e.g., section 3.3 in ][]{LetAl2018JAMES}. The GLL points are located at -1,$-\sqrt{5}/5$, $\sqrt{5}/5$, and 1 in each coordinate direction. Near the edges/corners of an element cubic extrapolation is used if the centered stencil expands beyond the panel.

\begin{figure}[t]
\noindent\includegraphics[width=19pc,angle=0]{figs/mapping/mapping.pdf}\\
\caption{Schematic of the coordinate system in which the dimensionally split cubic Lagrange interpolation is computed.  The physics grid centers are marked with asterisks and the GLL points, we are interpolating to, with solid filled circles. The element in which the GLL points are located is  bounded by  thick black lines and located in the lower left corner of a panel. The stippled lines mark the boundaries of the remaining elements. For simplicity we are using the normalized coordinate centered at the element on which the GLL points we are interpolating to are located. Note that the coordinates for points on neighboring panels (using a different local coordinate system) must be transformed to the coordinate system of the element in question.}
\label{fig:mapping}
\end{figure}

%\appendix

% Use \appendix[A], \appendix}[B], if you have multiple appendixes.
%\appendix[A]

%% Appendix title is necessary! For appendix title:
%\appendixtitle{}

%%% Appendix section numbering (note, skip \section and begin with \subsection)
% \subsection{First primary heading}

% \subsubsection{First secondary heading}

% \paragraph{First tertiary heading}

%% Important!
%\appendcaption{<appendix letter and number>}{<caption>} 
%must be used for figures and tables in appendixes, e.g.,
%
%\begin{figure}
%\noindent\includegraphics[width=19pc,angle=0]{figure01.pdf}\\
%\appendcaption{A1}{Caption here.}
%\end{figure}
%
% All appendix figures/tables should be placed in order AFTER the main figures/tables, i.e., tables, appendix tables, figures, appendix figures.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% REFERENCES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Make your BibTeX bibliography by using these commands:
\bibliographystyle{ametsoc2014}
\bibliography{bib}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TABLES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Enter tables at the end of the document, before figures.
%%
%
%\begin{table}[t]
%\caption{This is a sample table caption and table layout.  Enter as many tables as
%  necessary at the end of your manuscript. Table from Lorenz (1963).}\label{t1}
%\begin{center}
%\begin{tabular}{ccccrrcrc}
%\hline\hline
%$N$ & $X$ & $Y$ & $Z$\\
%\hline
% 0000 & 0000 & 0010 & 0000 \\
% 0005 & 0004 & 0012 & 0000 \\
% 0010 & 0009 & 0020 & 0000 \\
% 0015 & 0016 & 0036 & 0002 \\
% 0020 & 0030 & 0066 & 0007 \\
% 0025 & 0054 & 0115 & 0024 \\
%\hline
%\end{tabular}
%\end{center}
%\end{table}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% FIGURES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Enter figures at the end of the document, after tables.
%%
%
%\begin{figure}[t]
%  \noindent\includegraphics[width=19pc,angle=0]{figure01.pdf}\\
%  \caption{Enter the caption for your figure here.  Repeat as
%  necessary for each of your figures. Figure from \protect\cite{Knutti2008}.}\label{f1}
%\end{figure}

\end{document}
